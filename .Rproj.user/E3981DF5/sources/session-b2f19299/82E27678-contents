# Mon Mar 07 14:32:23 2022 ------------------------------
# Loading packages
library(picante)
library(RRphylo)
library(Rphylopars)
library(phytools)
library(ape)
library(letsR)
library(visdat)
library(tidyverse)

#--- Extract data ---#
# phylogeny 
setwd("C:/Users/Cliente/Desktop/biogeo_vertebrates-main/phylogeny")
anura.phy <- read.tree("phy_amphibia.tre")
reptile.phy <- read.tree("phy_reptile.tre")
birds.phy <- read.tree("phy_birds.tre")
mammals.phy <- read.nexus("https://raw.githubusercontent.com/n8upham/MamPhy_v1/master/_DATA/MamPhy_fullPosterior_BDvr_DNAonly_4098sp_topoFree_FBDasZhouEtAl_MCC_v2_target.tre") 

# functional traits
setwd("C:/Users/Cliente/Desktop/biogeo_vertebrates-main/trait_data")
amphibia_full_traits <- as.tibble(read.csv2("traits_amphibia.csv"))
reptile_full_traits <- as.tibble(read.csv2("traits_squamatas.csv"))
birds_full_traits <- as.tibble(read.csv2("traits_birds.csv"))
mammals_full_traits <- as.tibble(read.csv2("traits_mammals.csv"))

# Fri Apr 29 12:56:25 2022 ------------------------------
#--- Transform ---#

#--- Adjusting in nomenclature
amphibia_full_traits$sp <- amphibia_full_traits$sp %>% str_replace_all( "Boana_claresignata", "Bokermannohyla_claresignata") %>% str_replace_all("Boana_clepsydra", "Bokermannohyla_clepsydra") %>% str_replace_all("Proceratophrys_salvatori", "Odontophrynus_salvatori") %>%  str_replace_all("Scinax_v_signatus", "Scinax_v-signatus") %>% str_replace_all("Scinax_x_signatus", "Scinax_x-signatus") %>% str_replace_all("Boana_bandeirantes", "Hypsiboas_bandeirantes") %>% str_replace_all("Boana_poaju", "Hypsiboas_poaju") %>% str_replace_all("Boana_paranaiba", "Hypsiboas_paranaiba") %>% str_replace_all("Physalaemus_nattereri", "Eupemphix_nattereri") %>% str_replace_all("Agalychnis_aspera", "Hylomantis_aspera") %>% str_replace_all("Agalychnis_granulosa", "Hylomantis_granulosa") %>% str_replace_all("Lithobates_palmipes", "Rana_palmipes") %>% str_replace_all("Pithecopus_azureus", "Phyllomedusa_azurea") %>% str_replace_all("Pithecopus_ayeaye", "Phyllomedusa_ayeaye") %>% str_replace_all("Pithecopus_nordestinus", "Phyllomedusa_nordestina") %>% str_replace_all("Pithecopus_rohdei", "Phyllomedusa_rohdei") %>% str_replace_all("Pithecopus_rohdei", "Phyllomedusa_rohdei") %>% str_replace_all("Aparasphenodon_ararapa", "Aparasphenodon_arapapa") %>% str_replace_all("Ololygon_tripui", "Scinax_tripui") %>% str_replace_all("Ololygon_cosenzai", "Scinax_cosenzai") %>% str_replace_all("Ololygon_strigilata", "Scinax_strigilatus") %>% str_replace_all("Pithecopus_hypochondrialis", "Phyllomedusa_hypochondrialis") %>% str_replace_all("Pithecopus_megacephalus","Phyllomedusa_megacephala") %>% str_replace_all("Pithecopus_hypochondrialis", "Phyllomedusa_hypochondrialis") 

#--- Selecting continuous variables
amphibia_traits <- amphibia_full_traits %>% dplyr::select(c(sp, Body_size_mm,Brood.Size)) %>% rename(body_size = Body_size_mm, litter_size = Brood.Size)
vis_miss(amphibia_traits) # 64.64% NA in brood size ~ 3.72% body size

reptile_traits <- reptile_full_traits %>% dplyr::select(c(sp, SVL..mm.,litter_or_clutch_size_n)) %>% rename(body_size = SVL..mm., litter_size = litter_or_clutch_size_n)
vis_miss(reptile_traits) # 57.91% NA in brood size ~ 14.84% body size

birds_traits <- birds_full_traits %>% dplyr::select(c(sp, BodyMass.Value,litter_or_clutch_size_n)) %>% rename(body_mass = BodyMass.Value, litter_size = litter_or_clutch_size_n)
vis_miss(birds_traits) # 29.51% NA in litter_size ~ 9.62% body_mass

mammals_traits <- mammals_full_traits %>% dplyr::select(c(sp, body_mass_g.avg.,Littersize)) %>% rename(body_mass = body_mass_g.avg., litter_size = Littersize)
vis_miss(mammals_traits) # 0.92% NA in body_mass ~ 22.46% litter_size

#--- Checking phylogenis
# Transposition
amphibia_trans <- t(amphibia_traits_short)
colnames(amphibia_trans) <- amphibia_trans[1,]
amphibia_trans <- amphibia_trans[-1, ] #remove sp line 
amphibia_trans <- amphibia_trans[,-34 ]#Aplastodiscus_weygoldti two times
#View(amphibia_trans)

#
match.phylo.comm(anura.phy, amphibia_trans)
anura_phy <- prune.sample(amphibia_trans, anura.phy)
ncol(amphibia_trans) #562 cols or spp
anura_phy #562 tips

#
rem.col.phy <- c("Brachycephalus_sulfuratus","Chiasmocleis_alagoana","Crossodactylus_fransciscanus","Crossodactylus_timbuhy","Crossodactylus_werneri","Dendropsophus_bromeliaceus","Eleutherodactylus_bilineatus","Melanophryniscus_milanoi","Melanophryniscus_xanthostomus","Scinax_strigilatus","Ololygon_tupinamba","Phyllodytes_megatympanum","Physalaemus_atim","Proceratophrys_mantiqueira","Proceratophrys_phyllostoma","Proceratophrys_pombali","Proceratophrys_tupinamba","Pseudopaludicola_atragula","Pseudopaludicola_jaredi","Pseudopaludicola_pocoto","Rhinella_sebbeni","Scinax_caissara","Scinax_melanodactylus","Scinax_rossaferesae","Scinax_skuki","Sphaenorhynchus_canga","Trachycephalus_typhonius","Vitreorana_baliomma")

amphibia_traits_short <- amphibia_traits[!amphibia_traits$sp %in% rem.col.phy,]
amphibia_traits_short <- amphibia_traits_short[-34,]
View(amphibia_traits_short)


#nrow(amphibia_traits_short)

# Fri Apr 29 17:06:10 2022 ------------------------------
### Testando a imputação 
test <- as.data.frame(amphibia_traits_short)

test <- test %>% rename(species = sp) 
test$body_size <- as.numeric(test$body_size)
test$litter_size <- as.numeric(test$litter_size)
View(as.matrix(test))
rownames(test) <- test$species

test2 <- test[,-1]
class(test)

View(test)
View(test2)
#list1 <- list(anura_phy)
#list2 <- list(test)
#appended_list <- append(list1, list2)
#View(appended_list)
phylo.heatmap(amphibia_phy_rooted,as.matrix(test2),standardize=TRUE,lwd=3,pts=FALSE)
View(as.matrix(test))

?phylo.heatmap

# Imputação dados faltantes - SVL/Body mass - Número de prole
#Brownian motion
p_BM <- phylopars(trait_data = test, tree = amphibia_phy_rooted,  pheno_error = TRUE,phylo_correlated = TRUE,pheno_correlated = TRUE)


p_BM$anc_recon[1:20,] # Data with imputed species means
p_BM$anc_var[1:20,] # Variances for each estimate
p_BM$anc_recon[1:20,] - sqrt(p_BM$anc_var[1:20,])*1.96 # Lower 95% CI
p_BM$anc_recon[1:20,] + sqrt(p_BM$anc_var[1:20,])*1.96 # Upper 95% CI

phylo.heatmap(amphibia_phy_rooted,as.matrix(traits_amphy_input),standardize=TRUE,lwd=3,
              pts=FALSE)
###
anura_phy_ultra <- force.ultrametric(anura_phy)
amphibia_phy_rooted <- ape::multi2di(anura_phy_ultra)
is.ultrametric(amphibia_phy_rooted)

p_OU <- phylopars(trait_data = test, tree = amphibia_phy_rooted,  pheno_error = TRUE,phylo_correlated = TRUE,pheno_correlated = TRUE, model="mvOU")

amphibia_phy_rooted

p_OU$anc_recon[1:20,] # Data with imputed species means
p_OU$anc_var[1:20,] # Variances for each estimate

p_OU$anc_recon[1:20,] - sqrt(p_BM$anc_var[1:20,])*1.96 # Lower 95% CI
p_OU$anc_recon[1:20,] + sqrt(p_BM$anc_var[1:20,])*1.96 # Upper 95% CI
View(p_OU$anc_recon)

###
# Traits amphibia
traits_amphy_input <- p_BM$anc_recon[1:562,]
traits_amphy_input <- as.data.frame(traits_amphy_input)
###
View(traits_amphy_input)
#--- Taxa de evolução dos atributos
svl <- log10(as.numeric(traits_amphy_input$body_size))
names(svl) <- rownames(traits_amphy_input)
svl

rates.anura <- RRphylo(tree= amphibia_phy_rooted, y=svl)
rates_anura <- rates.anura$rates[546:1091,]
View(rates_anura)
?RRphylo

### Dataset Squamata
# Transposition
reptile_trans <- t(reptile_traits_short)
colnames(reptile_trans) <- reptile_trans[1,]
reptile_trans <- reptile_trans[-1, ] #remove sp line 

View(reptile_trans)
#
match.phylo.comm(reptile.phy, reptile_trans)
reptile_phy <- prune.sample(reptile_trans, reptile.phy)
ncol(reptile_trans) #562 cols or spp
reptile_phy #405 tips

# Remove from datsaset
rem.col.phy <- c("Amerotyphlops_arenensis","Amphisbaena_metallurga","Leposternon_polystegum ","Kinosternon_scorpioides","Paleosuchus_palpebrosus","Tomodon_dorsatus")

reptile_traits_short <- reptile_traits[!reptile_traits$sp %in% rem.col.phy,]
nrow(reptile_traits_short)

# Extrair váriaveis climáticas - LetsR
# modelos PGLS